<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="cn" lang="cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>事务 - CodeIgniter 中文手册</title>
<link rel="stylesheet" type="text/css" media="all" href="../userguide.css" />
<link rel="search" href="http://codeigniter.org.cn/CodeIgniterSearch.xml" type="application/opensearchdescription+xml" title="CodeIgniter 搜索"/>
<script type="text/javascript" src="../nav/nav.js"></script>
<script type="text/javascript" src="../nav/prototype.lite.js"></script>
<script type="text/javascript" src="../nav/moo.fx.js"></script>
<script type="text/javascript" src="../nav/user_guide_menu.js"></script>
<meta name="robots" content="all" />
<meta name="author" content="ExpressionEngine Dev Team" />
<meta name="description" content="CodeIgniter 中文手册, CodeIgniter 用户指南, CodeIgniter User Guide, Wiki 文档" />
</head>
<body>
<!-- START NAVIGATION -->
<div id="nav">
  <div id="nav_inner">
    <script type="text/javascript">create_menu('../');</script>
  </div>
</div>
<div id="nav2"><a name="top"></a><a href="javascript:void(0);" onclick="myHeight.toggle();"><img src="../images/nav_toggle.jpg" width="153" height="44" border="0" title="切换目录" alt="切换目录" /></a></div>
<div id="masthead">
  <table cellpadding="0" cellspacing="0" border="0" style="width:100%">
    <tr>
      <td width="350"><h1>CodeIgniter 用户指南 版本 1.6.3</h1></td>
      <td id="breadcrumb_right"><a href="../toc.html">目录页</a></td>
    </tr>
  </table>
</div>
<!-- END NAVIGATION -->
<!-- START BREADCRUMB -->
<table cellpadding="0" cellspacing="0" border="0" style="width:100%">
  <tr>
    <td id="breadcrumb">
		<a href="http://codeigniter.org.cn/" target="_blank">CodeIgniter 中国首页</a>&nbsp;&#8250;&nbsp;
<a href="../index.html">用户指南首页</a>&nbsp;&#8250;&nbsp;<a href="index.html">数据库类</a>&nbsp;&#8250;&nbsp;事务	</td>
    <td id="searchbox">
		<form method="get" action="http://www.google.com/search" target="google_window">
		<input type="hidden" name="client" value="pub-0176846097796333"></input>
		<input type="hidden" name="forid" value="1"></input>
		<input type="hidden" name="ie" value="UTF-8"></input>
		<input type="hidden" name="oe" value="UTF-8"></input>
        <input type="hidden" name="as_sitesearch" id="as_sitesearch" value="codeigniter.org.cn/user_guide/" />
        搜索用户指南&nbsp;
        <input type="text" class="input" style="width:200px;" name="q" id="q" size="31" maxlength="255" value="" />
        &nbsp;
        <input type="submit" class="submit" name="sa" value="Go" />
      </form>
	</td>
  </tr>
</table>
<!-- END BREADCRUMB -->
<!--<br clear="all" />-->
<!-- START CONTENT -->
<div id="content">
<h1>事务</h1>

<p>CodeIgniter的数据库抽象允许你在支持事务安全的数据库表中使用<dfn>事务</dfn>在MySQL中，你需要用InnoDB或BDB表而不是更常用的MyISAM。Most other database platforms support transactions natively.</p>

<p>如果你对事务不熟悉，我们建议您上网寻找相关资源学习。以下信息假设你已经明白事务的相关概念。</p>

<h2>CodeIgniter's Approach to Transactions</h2>

<p>CodeIgniter utilizes an approach to transactions that is very similar to the process used by the popular database class ADODB.  We've chosen that approach
because it greatly simplifies the process of running transactions.  In most cases all that is required are two lines of code.</p>

<p>Traditionally, transactions have required a fair amount of work to implement since they demand that you to keep track of your queries
and determine whether to <dfn>commit</dfn> or <dfn>rollback</dfn> based on the success or failure of your queries. This is particularly cumbersome with
nested queries. In contrast,
we've implemented a smart transaction system that does all this for you automatically (you can also manage your transactions manually if you choose to,
but there's really no benefit).</p>

<h2>Running Transactions</h2>

<p>To run your queries using transactions you will use the <dfn>$this-&gt;db-&gt;trans_start()</dfn> and <dfn>$this-&gt;db-&gt;trans_complete()</dfn> functions as follows:</p>

<code>
<kbd>$this-&gt;db-&gt;trans_start();</kbd><br />
$this-&gt;db-&gt;query('AN SQL QUERY...');<br />

$this-&gt;db-&gt;query('ANOTHER QUERY...');<br />
$this-&gt;db-&gt;query('AND YET ANOTHER QUERY...');<br />
<kbd>$this-&gt;db-&gt;trans_complete();</kbd>
</code>

<p>You can run as many queries as you want between the start/complete functions and they will all be committed or rolled back based on success or failure
of any given query.</p>

<h2>Strict Mode</h2>

<p>By default CodeIgniter runs all transactions in <dfn>Strict Mode</dfn>.  When strict mode is enabled, if you are running multiple groups of
transactions, if one group fails all groups will be rolled back. If strict mode is disabled, each group is treated independently, meaning
a failure of one group will not affect any others.</p>

<p>Strict Mode can be disabled as follows:</p>

<code>$this-&gt;db-&gt;trans_strict(FALSE);</code>


<h2>Managing Errors</h2>

<p>If you have error reporting enabled in your <dfn>config/database.php</dfn> file you'll see a standard error message if the commit was unsuccessful. If debugging is turned off, you can
manage your own errors like this:</p>

<code>
$this-&gt;db-&gt;trans_start();<br />
$this-&gt;db-&gt;query('AN SQL QUERY...');<br />
$this-&gt;db-&gt;query('ANOTHER QUERY...');<br />
$this-&gt;db-&gt;trans_complete();<br />
<br />
if (<kbd>$this-&gt;db-&gt;trans_status()</kbd> === FALSE)<br />
&#123;<br />

&nbsp;&nbsp;&nbsp;&nbsp;// generate an error... or use the log_message() function to log your error<br />
&#125;
</code>


<h2>Enabling Transactions</h2>

<p>Transactions are enabled automatically the moment you use <dfn>$this-&gt;db-&gt;trans_start()</dfn>.  If you would like to disable transactions you
can do so using <dfn>$this-&gt;db-&gt;trans_off()</dfn>:</p>

<code>

<kbd>$this-&gt;db-&gt;trans_off()</kbd><br /><br />

$this-&gt;db-&gt;trans_start();<br />
$this-&gt;db-&gt;query('AN SQL QUERY...');<br />
$this-&gt;db-&gt;trans_complete();
</code>

<p class="important">When transactions are disabled, your queries will be auto-commited, just as they are when running queries without transactions.</p>


<h2>Test Mode</h2>

<p>You can optionally put the transaction system into "test mode", which will cause your queries to be rolled back -- even if the queries produce a valid result.
To use test mode simply set the first parameter in the <dfn>$this-&gt;db-&gt;trans_start()</dfn> function to <samp>TRUE</samp>:</p>

<code>
$this-&gt;db-&gt;trans_start(<samp>TRUE</samp>); // Query will be rolled back<br />
$this-&gt;db-&gt;query('AN SQL QUERY...');<br />
$this-&gt;db-&gt;trans_complete();
</code>


<h2>Running Transactions Manually</h2>

<p>If you would like to run transactions manually you can do so as follows:</p>

<code>
$this-&gt;db-&gt;trans_begin();<br /><br />

$this-&gt;db-&gt;query('AN SQL QUERY...');<br />
$this-&gt;db-&gt;query('ANOTHER QUERY...');<br />
$this-&gt;db-&gt;query('AND YET ANOTHER QUERY...');<br />

<br />

if ($this-&gt;db-&gt;trans_status() === FALSE)<br />
&#123;<br />
&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;db-&gt;trans_rollback();<br />
&#125;<br />
else<br />
&#123;<br />
&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;db-&gt;trans_commit();<br />

&#125;<br />
</code>

<p class="important"><strong>Note:</strong> Make sure to use <kbd>$this-&gt;db-&gt;trans_begin()</kbd> when running manual transactions, <strong>NOT</strong>
<dfn>$this-&gt;db-&gt;trans_start()</dfn>.</p><p>&nbsp;</p>
<div id="Contributors">
翻译贡献者:
Hex, iptton</div>
<div id="DocDate">最后修改: 2008-06-28 10:07:13</div>
</div>
<!-- END CONTENT -->
<div id="footer">
  <p>
上一个主题:&nbsp;&nbsp;<a href="../database/fields.html">字段元数据</a>&nbsp;&nbsp;&middot;&nbsp;&nbsp;<a href="#top">页首</a>
&nbsp;&middot;&nbsp;&nbsp;<a href="../index.html">用户指南首页</a>&nbsp;&nbsp;&middot;&nbsp;&nbsp;下一个主题:&nbsp;&nbsp;<a href="../database/table_data.html">数据库表元数据</a>  </p>
  <p><a href="http://codeigniter.com" target="_blank">CodeIgniter</a> &nbsp;&middot;&nbsp; 版权所有 &#169; 2006-2008 &nbsp;&middot;&nbsp; <a href="http://ellislab.com/" target="_blank">Ellislab, Inc.</a></p>
  <p>中文化: <a href="http://codeigniter.org.cn" target="_blank">CodeIgniter 中国</a> &nbsp;&middot;&nbsp; 制作: Hex &nbsp;&middot;&nbsp; 生成日期: 2008-09-22 01:15</p>
</div>
</body>
</html>