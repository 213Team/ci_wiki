<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="cn" lang="cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Session 类 - CodeIgniter 中文手册</title>
<link rel="stylesheet" type="text/css" media="all" href="../userguide.css" />
<link rel="search" href="http://codeigniter.org.cn/CodeIgniterSearch.xml" type="application/opensearchdescription+xml" title="CodeIgniter 搜索"/>
<script type="text/javascript" src="../nav/nav.js"></script>
<script type="text/javascript" src="../nav/prototype.lite.js"></script>
<script type="text/javascript" src="../nav/moo.fx.js"></script>
<script type="text/javascript" src="../nav/user_guide_menu.js"></script>
<meta name="robots" content="all" />
<meta name="author" content="ExpressionEngine Dev Team" />
<meta name="description" content="CodeIgniter 中文手册, CodeIgniter 用户指南, CodeIgniter User Guide, Wiki 文档" />
</head>
<body>
<!-- START NAVIGATION -->
<div id="nav">
  <div id="nav_inner">
    <script type="text/javascript">create_menu('../');</script>
  </div>
</div>
<div id="nav2"><a name="top"></a><a href="javascript:void(0);" onclick="myHeight.toggle();"><img src="../images/nav_toggle.jpg" width="153" height="44" border="0" title="切换目录" alt="切换目录" /></a></div>
<div id="masthead">
  <table cellpadding="0" cellspacing="0" border="0" style="width:100%">
    <tr>
      <td width="350"><h1>CodeIgniter 用户指南 版本 1.6.3</h1></td>
      <td id="breadcrumb_right"><a href="../toc.html">目录页</a></td>
    </tr>
  </table>
</div>
<!-- END NAVIGATION -->
<!-- START BREADCRUMB -->
<table cellpadding="0" cellspacing="0" border="0" style="width:100%">
  <tr>
    <td id="breadcrumb">
		<a href="http://codeigniter.org.cn/" target="_blank">CodeIgniter 中国首页</a>&nbsp;&#8250;&nbsp;
<a href="../index.html">用户指南首页</a>&nbsp;&#8250;&nbsp;<a href="index.html">类库</a>&nbsp;&#8250;&nbsp;Session 类	</td>
    <td id="searchbox">
		<form method="get" action="http://www.google.com/search" target="google_window">
		<input type="hidden" name="client" value="pub-0176846097796333"></input>
		<input type="hidden" name="forid" value="1"></input>
		<input type="hidden" name="ie" value="UTF-8"></input>
		<input type="hidden" name="oe" value="UTF-8"></input>
        <input type="hidden" name="as_sitesearch" id="as_sitesearch" value="codeigniter.org.cn/user_guide/" />
        搜索用户指南&nbsp;
        <input type="text" class="input" style="width:200px;" name="q" id="q" size="31" maxlength="255" value="" />
        &nbsp;
        <input type="submit" class="submit" name="sa" value="Go" />
      </form>
	</td>
  </tr>
</table>
<!-- END BREADCRUMB -->
<!--<br clear="all" />-->
<!-- START CONTENT -->
<div id="content">
<h1>Session 类</h1>

<p>Session类可以使用户在浏览您的网站时，维持他们的状态并跟踪他们的行为。
Session类将每个用户的session信息序列化（serialize）后存储到到cookie中（并同时进行加密）。
您还可以将session数据存储到数据库中来增强安全性，但是这时要求存储在用户cookie中的session ID值能与数据库中存储的用户session ID值相匹配。程序默认只在cookie中存储session。如果您在要在数据库中存储session的话，需要按照下面指示的方法，在您的数据库中创建需要的数据表。
</p>

<p class="important"><strong>注意：</strong> Session类并不使用PHP本身的session，而是使用类自己的session，这样做，可以给开发者提供更大的弹性。</p>

<h2>初始化 Session</h2>

<p>Sessions会在每个页面载入后开始运行，所以session类必须首先被<a href="../general/libraries.html">初始化</a>。您可以在<a href="../general/controllers.html">控制器</a>中初始化，也可以在系统中<a href="../general/autoloader.html">自动加载</a>（译者注：在autoload.php设定）。session类的绝大部分都会在后台运行，所以初始化session时，它session数据会被自动读取、创建和更新。</p>


<p>要在您的控制器构造函数中初始化session类，您可以使用 <dfn>$this-&gt;load-&gt;library</dfn> 函数:</p>

<code>$this-&gt;load-&gt;library('session');</code>
<p>一旦被载入, session就可以这样使用： <dfn>$this-&gt;session</dfn></p>


<h2>Sessions 是怎样工作的？</h2>

<p>当页面载入后，session类就会检查用户的cookie中是否存在有效的session数据。如果session数据不存在（或者已经过期），那么就会创建一个新的session并把他保存在cookie中。如果session数据存在，那么他的信息就会被更新，同时cookie也会被同时更新。每次更新都会重新生成session_id的值。</p>

<p>对于您来说，需要知道的非常重要的一点就是，session类一旦被初始化，它就会自动运行。对于后面的事情，您可以完全不作理会。正如您将会在下面看到的一样，您可以正常使用session来工作，甚至还可以添加自己的session数据，而在这一切的过程中，读、写和更新的操作都是自动完成的。</p>


<h2>Session 数据是什么？</h2>

<p>一个 <em>session</em> 是由一个包括下列信息的数组组成的：</p>

<ul>
<li>唯一的用户Session ID (这是一个平均信息量统计出来的非常坚固的随机字符串，使用MD5加密，默认是每五分钟就重新生成一次。</li>
<li>用户的 IP 地址</li>
<li>用户浏览器信息（取前50个字符）</li>
<li>最新的一个活跃时间戳.</li>
</ul>

<p>以上数据将会用以下数组格式序列化并存到cookie里：</p>

<code>[array]<br />
(<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'session_id'&nbsp;&nbsp;&nbsp;&nbsp;=> random hash,<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'ip_address'&nbsp;&nbsp;&nbsp;&nbsp;=> 'string - user IP address',<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'user_agent'&nbsp;&nbsp;&nbsp;&nbsp;=> 'string - user agent data',<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'last_activity' => timestamp<br />
)</code>

<p>如果你将加密设置开启，serialized 的数组会被先被加密，然后存入cookie中。这会让数据不容易被看到和修改，从而提高安全性。从<a href="encryption.html">这里</a>可以找到更多关于加密的信息。Session类会自动负责初始化和数据加密。</p>

<p>注意: 默认情况下, Session Cookie 每隔 5 分钟才会更新一次,这样会减少对处理器的负荷。如果你重复的装载页面， 你会发现"上次活动"的时间在五分钟，或多余五分钟的时候才会变化，也就是 cookie 上次被写入的时间。 这个时间可以通过设置 system/config/config.php 文件里的 $config['time_to_update'] 行来改变。</p>

<h2>取得 Session 数据</h2>

<p>可以通过如下的函数来得到 session 数组的任何信息:</p>

<code>$this-&gt;session-&gt;userdata('<samp>item</samp>');</code>

<p><samp>item</samp> 是数组里的相对应数据的索引。例如，想要获得 session ID， 你要使用如下的代码:</p>

<code>$session_id = $this-&gt;session-&gt;userdata('<samp>session_id</samp>');</code>

<p><strong>注意:</strong> 如果你的目标数据不存在的话，这个函数会返回 FALSE (布尔值boolean)。</p>


<h2>添加自定义的 Session 数据</h2>

<p>session 数组的一个非常有用的用途是你可以它里面添加你自己的数据，这些数据会被保存在用户的 cookie 中。这样做的原因是什么呢？看看这个例子:</p>

<p>假设，有个特定用户登陆到你的网站， 当他通过检测后 你可以添加他的用户名和电子邮件到 session cookie 中，这些信息可以在不去访问数据库的情况下，当成全局量来使用。</p>

<p>通过以下函数，你可以传递一个新的用户数组到 session 数组中:</p>

<code>$this-&gt;session-&gt;set_userdata(<samp>$array</samp>);</code>

<p> <samp>$array</samp> 是一个结合数组，用来存储你的新数据。例如  :</p>


<p><code>$newdata = array(<br />
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'username'&nbsp; => 'johndoe',<br />
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'email'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=> 'johndoe@some-site.com',<br />
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'logged_in' => TRUE<br />
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br />
    <br />
    $this-&gt;session-&gt;set_userdata(<samp>$newdata</samp>);</code></p>
<p>如果使用下面 set_userdata()函数的写法,可以每次只添加一个用户数据。</p>
<p><code>$this-&gt;session-&gt;set_userdata('some_name', 'some_value');</code></p>
<p class="important"><strong>注意:</strong> Cookies 只能存储 4KB 的数据, 使用时要小心超出它的容量。特别指出的是，加密会产生比原数据更长的数据字符串，所以一定要当心你要存放数据的大小。</p>

<h2>删除 Session 数据</h2>
<p>正如使用 set_userdata() 是用来添加信息到 session 中，而通过向 unset_userdata() 函数中传递 session key 可以用来删除这些信息。例如, 你想要从 session 信息里去掉 'some_name': </p>
<p><code>$this-&gt;session-&gt;unset_userdata('some_name');</code></p>
<p>This function can also be passed an associative array of items to unset.</p>
<p><code>$array_items = array('username' => '', 'email' => '');<br />
<br />
$this-&gt;session-&gt;unset_userdata(<samp>$array_items</samp>);</code></p>
<h2>闪电数据</h2>
<p>CodeIgniter supports &quot;flashdata&quot;, or session data that will only be available for the next server request, and are then automatically cleared. These can be very useful, and are typically used for informational or status messages (for example: &quot;record 2 deleted&quot;).</p>
<p>Note: Flash variables are prefaced with &quot;flash_&quot; so avoid this prefix in your own session names.</p>
<p>To add flashdata:</p>
<p><code>$this-&gt;session-&gt;set_flashdata('item', 'value');</code></p>
<p>You can also pass an array to set_flashdata(), in the same manner as set_userdata(). </p>
<p>To read a flashdata variable:</p>
<p><code>$this-&gt;session-&gt;flashdata('item');</code></p>
<p>If you find that you need to preserve a flashdata variable through an additional request, you can do so using the keep_flashdata() function.</p>
<p><code>$this-&gt;session-&gt;keep_flashdata('item');</code></p>

<h2>将 Session 数据存入数据库</h2>
<p>While the session data array stored in the user's cookie contains a Session ID,
unless you store session data in a database there is no way to validate it.  For some applications that require little or no
security, session ID validation may not be needed, but if your application requires security, validation is mandatory.</p>

<p>When session data is available in a database, every time a valid session is found in the user's cookie, a database
query is performed to match it.  If the session ID does not match, the session is destroyed.  Session IDs can never
be updated, they can only be generated when a new session is created.</p>

<p>In order to store sessions, you must first create a database table for this purpose.  Here is the basic
prototype (for MySQL) required by the session class:</p>

<textarea class="textarea" style="width:100%" cols="50" rows="8">
CREATE TABLE IF NOT EXISTS  `ci_sessions` (
session_id varchar(40) DEFAULT '0' NOT NULL,
ip_address varchar(16) DEFAULT '0' NOT NULL,
user_agent varchar(50) NOT NULL,
last_activity int(10) unsigned DEFAULT 0 NOT NULL,
PRIMARY KEY (session_id)
);</textarea>

<p><strong>Note:</strong> By default the table is called <dfn>ci_sessions</dfn>, but you can name it anything you want
as long as you update the <kbd>application/config/config.php</kbd> file so that it contains the name you have chosen.
Once you have created your database table you can enable the database option in your config.php file as follows:</p>

<code>$config['sess_use_database'] = TRUE;</code>

<p>Once enabled, the Session class will store session data in the DB.</p>

<p>Make sure you've specified the table name in your config file as well:</p>

<code>$config['sess_table_name'] = 'ci_sessions";</code>

<p class="important"><strong>Note:</strong> The Session class has built-in garbage collection which clears out expired sessions so you
do not need to write your own routine to do it.</p>


<h2>注销 Session </h2>
<p>清除现有的 session: </p>
<code>$this-&gt;session-&gt;sess_destroy();</code>
<p class="important"><strong>Note:</strong> This function should be the last one called, and even flash variables will no longer be available.  If you only want some items destroyed and not all, use <dfn>unset_userdata()</dfn>.</p>

<h2>Session 的参数</h2>
<p>你可以在<kbd>application/config/config.php</kbd> 文件中找到以下的 Session 相关的参数:</p>


<table cellpadding="0" cellspacing="1" border="0" style="width:100%" class="tableborder">
<tr>
    <th>参数</th>
    <th>默认</th>
    <th>选项</th>
    <th>描述</th>
</tr>
<tr>
    <td class="td"><strong>sess_cookie_name</strong></td>
    <td class="td">ci_session</td>
    <td class="td">无</td>
    <td class="td">你想要保存 Session Cookie 的名字。</td>
</tr>
<tr>
    <td class="td"><strong>sess_expiration</strong></td>
    <td class="td">7200</td>
    <td class="td">无</td>
    <td class="td">session 持续的秒数。默认是2个小时(7200秒)。如果将这个数值设为: 0，就可以得到 永久 session。</td>
</tr>
<tr>
    <td class="td"><strong>sess_encrypt_cookie</strong></td>
    <td class="td">FALSE</td>
    <td class="td">TRUE/FALSE (布尔值boolean)</td>
    <td class="td">是否对 session 数据加密.</td>
</tr>
<tr>
    <td class="td"><strong>sess_use_database</strong></td>
    <td class="td">FALSE</td>
    <td class="td">TRUE/FALSE (布尔值boolean)</td>
    <td class="td">是否将 session 数据存放入数据库中。在开启这个选项前，你要先创建一个数据库表。</td>
</tr>
<tr>
    <td class="td"><strong>sess_table_name</strong></td>
    <td class="td">ci_sessions</td>
    <td class="td">任何有效的 SQL 表名</td>
    <td class="td">session 数据库表的名字。</td>
</tr>
<tr>
    <td class="td"><strong>sess_time_to_update</strong></td>
    <td class="td">300</td>
    <td class="td">时间以秒计算</td>
    <td class="td">这个选项控制 session 类多久会产生一个新的session 和 session id。</td>
</tr>
<tr>
    <td class="td"><strong>sess_match_ip</strong></td>
    <td class="td">FALSE</td>
    <td class="td">TRUE/FALSE (布尔值boolean)</td>
    <td class="td">是否通过用户的IP地址来读取 session 的数据。 注意 ，有些网络运行商 ISPs 会动态的改变IP, 所以将这个选项设为 FALSE， 才有可能得到永久的 session。</td>
</tr>
<tr>
    <td class="td"><strong>sess_match_useragent</strong></td>
    <td class="td">TRUE</td>
    <td class="td">TRUE/FALSE (布尔值boolean)</td>
    <td class="td">是否要按照对应的 User Agent 来读取 session 数据。</td>
</tr>
</table><p>&nbsp;</p>
<div id="Contributors">
翻译贡献者:
aykirk, guns1985, Hex, shishirui</div>
<div id="DocDate">最后修改: 2008-06-29 03:44:37</div>
</div>
<!-- END CONTENT -->
<div id="footer">
  <p>
上一个主题:&nbsp;&nbsp;<a href="../libraries/pagination.html">分页类</a>&nbsp;&nbsp;&middot;&nbsp;&nbsp;<a href="#top">页首</a>
&nbsp;&middot;&nbsp;&nbsp;<a href="../index.html">用户指南首页</a>&nbsp;&nbsp;&middot;&nbsp;&nbsp;下一个主题:&nbsp;&nbsp;<a href="../libraries/trackback.html">Trackback 类</a>  </p>
  <p><a href="http://codeigniter.com" target="_blank">CodeIgniter</a> &nbsp;&middot;&nbsp; 版权所有 &#169; 2006-2008 &nbsp;&middot;&nbsp; <a href="http://ellislab.com/" target="_blank">Ellislab, Inc.</a></p>
  <p>中文化: <a href="http://codeigniter.org.cn" target="_blank">CodeIgniter 中国</a> &nbsp;&middot;&nbsp; 制作: Hex &nbsp;&middot;&nbsp; 生成日期: 2008-09-22 01:15</p>
</div>
</body>
</html>